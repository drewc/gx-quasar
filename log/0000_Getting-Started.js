export default{$$data_type:"org-document",properties:{title:["gx-quasar->GxQuasar: a simple idea to Gerbilize Javascript"],filetags:[],author:[],creator:"Emacs 28.0.50 (Org mode 9.3)",date:[],description:[],email:"drewc@nyx",language:"en"},contents:[{$$data_type:"org-node",type:"section",ref:"org417aead",properties:{"post-blank":1,"post-affiliated":1},contents:[{$$data_type:"org-node",type:"keyword",ref:"orgfa47cb3",properties:{key:"TITLE",value:"gx-quasar->GxQuasar: a simple idea to Gerbilize Javascript","post-blank":1,"post-affiliated":1},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org38f2ad1",properties:{"post-blank":1,"post-affiliated":70},contents:["I've been a ",{$$data_type:"org-node",type:"bold",ref:"org4f4b146",properties:{"post-blank":0},contents:["[back|middle|front]"]},"-end web developer for pretty much my entire\ncareer. For the last 16 years or so (",{$$data_type:"org-node",type:"timestamp",ref:"orgcb45d90",properties:{type:"inactive","raw-value":"[2020-10-30 Fri]","post-blank":1,start:"2020-10-30",end:"2020-10-30"},contents:[]},"is today) I've used Lisp.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org91d8aaf",properties:{"post-blank":1,"post-affiliated":229},contents:["Javascript was actually developed based on scheme and prototyped in Common\nLisp",{$$data_type:"org-node",type:"footnote-reference",ref:"orgfe91dee",properties:{label:"1",type:"standard","post-blank":0},contents:[]},". I program in Gerbil Scheme",{$$data_type:"org-node",type:"footnote-reference",ref:"org14c3c67",properties:{label:"2",type:"standard","post-blank":0},contents:[]},", a meta-dialect of Scheme with\npost-modern features, whenever possible. The idea of using it for browser\ndevelopment certainly piqued my interest.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org510749d",properties:{"post-blank":0,"post-affiliated":497},contents:["This is an outline of the first attempt.\n"]}]},{$$data_type:"org-node",type:"headline",ref:"orgc9618fd",drawer:{},properties:{"tags-all":[],"raw-value":"Install Quasar","pre-blank":1,level:1,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":539,title:["Install Quasar"]},contents:[{$$data_type:"org-node",type:"section",ref:"org3a8cf16",properties:{"post-blank":1,"post-affiliated":557},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgf1cd243",properties:{"post-blank":1,"post-affiliated":557},contents:["My main use of the browser is a GUI for my systems. My laptop and servers run\nNixOS",{$$data_type:"org-node",type:"footnote-reference",ref:"org6d88f21",properties:{label:"3",type:"standard","post-blank":0},contents:[]},". We'll use the unstable ",{$$data_type:"org-node",type:"code",ref:"orgde6c949",properties:{value:"<nixpkgs>","post-blank":0},contents:[]},".\n"]},{$$data_type:"org-node",type:"src-block",ref:"org1d8ac6a",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"nix-channel --add https://nixos.org/channels/nixpkgs-unstable\nnix-channel --update\n","post-blank":1,"post-affiliated":685},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgf2fd0e3",properties:{"post-blank":0,"post-affiliated":797},contents:["NodeJS 12 and yarn are the current choices.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org4a6565f",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"nix-env -iA nixpkgs.yarn nixpkgs.yarn2nix nixpkgs.nodejs-12_x\n","post-blank":1,"post-affiliated":841},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org26ee49e",properties:{"post-blank":1,"post-affiliated":932},contents:[{$$data_type:"org-node",type:"link",ref:"org635ad7b",properties:{type:"https",path:"//quasar.dev/quasar-cli/installation",format:"plain","raw-link":"https://quasar.dev/quasar-cli/installation",application:null,"search-option":null,"post-blank":1,"is-internal":!1,"target-ref":null,"is-inline-image":!1},contents:[]},"is a quick read but in essence:\n"]},{$$data_type:"org-node",type:"src-block",ref:"org8a9d407",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'yarn global add @quasar/cli\n# in ~/.bashrc or equivalent\nexport PATH="$(yarn global bin):$PATH"\n\nLD=$CC yarn install\n',"post-blank":1,"post-affiliated":1008},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orga359502",properties:{"post-blank":1,"post-affiliated":1154},contents:["The ",{$$data_type:"org-node",type:"code",ref:"org7ca9397",properties:{value:"LD=$CC","post-blank":1},contents:[]},"is so the builder can find the libraries it wants. So create a\nproject.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org2778931",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"LD=$CC quasar create\n#  [...]\n#  [*] Quasar Project initialization finished!\n","post-blank":1,"post-affiliated":1240},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org511cbbb",properties:{"post-blank":1,"post-affiliated":1346},contents:["We'll also use it for dev.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org6e5d0d8",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"LD=$CC quasar dev\n","post-blank":0,"post-affiliated":1374},contents:[]}]}]},{$$data_type:"org-node",type:"headline",ref:"orge2cabbf",drawer:{},properties:{"tags-all":[],"raw-value":"Hello World! Let's get easy.","pre-blank":1,level:1,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":1421,title:["Hello World! Let's get easy."]},contents:[{$$data_type:"org-node",type:"section",ref:"org6711ee1",properties:{"post-blank":1,"post-affiliated":1453},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgcb8ef43",properties:{"post-blank":1,"post-affiliated":1453},contents:["Gerbil uses Gambit Scheme",{$$data_type:"org-node",type:"footnote-reference",ref:"org9bf4bd4",properties:{label:"4",type:"standard","post-blank":1},contents:[]},"as its backend/compiler. Gambit recently got a\nuniversal backend where it can compile to anything, and JavaScript AKA ",{$$data_type:"org-node",type:"code",ref:"orge45b374",properties:{value:"js","post-blank":1},contents:[]},"is\none of its targets.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org925ca4c",properties:{"post-blank":1,"post-affiliated":1632},contents:[{$$data_type:"org-node",type:"link",ref:"org29887bf",properties:{type:"https",path:"//mailman.iro.umontreal.ca/pipermail/gambit-list/2020-March/009363.html",format:"plain","raw-link":"https://mailman.iro.umontreal.ca/pipermail/gambit-list/2020-March/009363.html",application:null,"search-option":null,"post-blank":1,"is-internal":!1,"target-ref":null,"is-inline-image":!1},contents:[]},"is\na great overview.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org6f0a24a",properties:{"post-blank":1,"post-affiliated":1732},contents:["Marc Feeley goes into some detail here:\n",{$$data_type:"org-node",type:"link",ref:"orgb608986",properties:{type:"https",path:"//gitter.im/gambit/gambit?at=5bc7fb95435c2a518ec448d1",format:"plain","raw-link":"https://gitter.im/gambit/gambit?at=5bc7fb95435c2a518ec448d1",application:null,"search-option":null,"post-blank":0,"is-internal":!1,"target-ref":null,"is-inline-image":!1},contents:[]},"\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org1bdf4ae",properties:{"post-blank":0,"post-affiliated":1833},contents:["One things I do want to avoid is having to load the entire Gambit system (30MB+)\nevery time I use it. It's very easy to do.\n"]}]},{$$data_type:"org-node",type:"headline",ref:"org623aa82",drawer:{},properties:{"tags-all":[],"raw-value":"~hello-world-rt~ and ~hello-world.ss~ : The hello world program","pre-blank":1,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":0,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":1958,title:[{$$data_type:"org-node",type:"code",ref:"orgfa9d30e",properties:{value:"hello-world-rt","post-blank":1},contents:[]},"and ",{$$data_type:"org-node",type:"code",ref:"orgc020ce4",properties:{value:"hello-world.ss","post-blank":1},contents:[]},": The hello world program"]},contents:[{$$data_type:"org-node",type:"section",ref:"org0a77578",properties:{"post-blank":1,"post-affiliated":2026},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgdecd18a",properties:{"post-blank":1,"post-affiliated":2026},contents:["First our custom runtime library. We'll simply use gerbil and have nothing in\nit.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org93199ec",properties:{"post-blank":1,"post-affiliated":2109},contents:['By "nothing" I mean one function that runs at the very end of things and\ninitializes each gambit "module".\n']},{$$data_type:"org-node",type:"paragraph",ref:"orga033ee7",properties:{"post-blank":1,"post-affiliated":2217},contents:["The ",{$$data_type:"org-node",type:"code",ref:"orgaa20480",properties:{value:"(declare (extended-bindings))","post-blank":1},contents:[]},"is for the ",{$$data_type:"org-node",type:"code",ref:"orgb235805",properties:{value:"##","post-blank":1},contents:[]},"functions. Because we are\nnot using gambit for our runtime that's needed.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org356169f",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"(declare (extended-bindings))\n\n(def (run-each-module)\n  (declare (extended-bindings) (not safe))\n  (let ((mods (##vector-ref ##program-descr 0)))\n    (let loop ((i 1)) ;; start at module after the current one\n      (if (##fx< i (##vector-length mods))\n\t    (let ((mod (##vector-ref mods i)))\n\t      ((##vector-ref mod 4)) ;; call module's init procedure\n\t      (loop (##fx+ i 1)))))))\n\n(run-each-module) ;; run each module (after the current one)\n","post-blank":1,"post-affiliated":2344},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org74572a8",properties:{"post-blank":1,"post-affiliated":2821},contents:["Because we are using gerbil but want to use gambit as well, although ",{$$data_type:"org-node",type:"code",ref:"orgb1a310a",properties:{value:"gxc","post-blank":1},contents:[]},"does\nallow things to pass to ",{$$data_type:"org-node",type:"code",ref:"orga40a987",properties:{value:"gsc","post-blank":0},contents:[]},", we'll simply do it manually.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org79582c8",properties:{"post-blank":1,"post-affiliated":2962},contents:["Passing the ",{$$data_type:"org-node",type:"code",ref:"org5184889",properties:{value:"-v -d . -S -static","post-blank":1},contents:[]},"options tell ",{$$data_type:"org-node",type:"code",ref:"org42953e5",properties:{value:"gxc","post-blank":1},contents:[]},"that we want things our way.\n"]},{$$data_type:"org-node",type:"plain-list",ref:"org6389dc3",properties:{type:"descriptive",structure:[[3044,4,"- ",null,null,"-v",3067],[3067,4,"- ",null,null,"-d .",3113],[3113,4,"- ",null,null,"-S .",3159],[3159,4,"- ",null,null,"-static",3249]],"post-blank":1,"post-affiliated":3044},contents:[{$$data_type:"org-node",type:"item",ref:"org15bebd4",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":3044,tag:["-v"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org5c1f2a8",properties:{"post-blank":0,"post-affiliated":3056},contents:["Be verbose\n"]}]},{$$data_type:"org-node",type:"item",ref:"org9a33a50",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":3067,tag:["-d ."]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org40b0936",properties:{"post-blank":0,"post-affiliated":3081},contents:["Output to the current directory\n"]}]},{$$data_type:"org-node",type:"item",ref:"orgf943241",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":3113,tag:["-S ."]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org4df63ea",properties:{"post-blank":0,"post-affiliated":3127},contents:["Don't invoke ",{$$data_type:"org-node",type:"code",ref:"orgf294019",properties:{value:"gsc","post-blank":0},contents:[]},", we'll do it\n"]}]},{$$data_type:"org-node",type:"item",ref:"org7281d49",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":3159,tag:["-static"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org4e6bcf9",properties:{"post-blank":0,"post-affiliated":3176},contents:["output a gambit scheme file that is what ",{$$data_type:"org-node",type:"code",ref:"org333a873",properties:{value:"gxc","post-blank":1},contents:[]},"would have\noutput.\n"]}]}]},{$$data_type:"org-node",type:"src-block",ref:"org9d79f19",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gxc -v -d . -S -static hello-world-rt.ss\n# compile hello-world-rt.ss\n# compile hello-world-rt\n# compile ./hello-world-rt__0.scm\n# copy static module ./hello-world-rt__0.scm => ./static/hello-world-rt.scm\n# compile ./hello-world-rt__rt.scm\n# compile ./hello-world-rt.ssi\nrm hello-world-rt.ssi\n","post-blank":1,"post-affiliated":3250},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org8ed3c46",properties:{"post-blank":1,"post-affiliated":3571},contents:["Now time to play a gambit and output ",{$$data_type:"org-node",type:"code",ref:"org6304100",properties:{value:"js","post-blank":0},contents:[]},". We'll use ",{$$data_type:"org-node",type:"code",ref:"org776ae65",properties:{value:"gsc","post-blank":1},contents:[]},"with the following.\n"]},{$$data_type:"org-node",type:"plain-list",ref:"orgee9b81b",properties:{type:"descriptive",structure:[[3651,3,"- ",null,null,"-verbose",3727],[3727,3,"- ",null,null,"-target js",3767],[3767,3,"- ",null,null,"-c",3833],[3833,3,"- ",null,null,"-o",3871]],"post-blank":2,"post-affiliated":3651},contents:[{$$data_type:"org-node",type:"item",ref:"orgea2fa96",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":3651,tag:["-verbose"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgd66befd",properties:{"post-blank":0,"post-affiliated":3668},contents:["Verbosity is always a good thing while learning/debugging.\n"]}]},{$$data_type:"org-node",type:"item",ref:"org740776d",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":3727,tag:["-target js"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgefee4f7",properties:{"post-blank":0,"post-affiliated":3746},contents:["Aim for JavaScript!!\n"]}]},{$$data_type:"org-node",type:"item",ref:"orgb907974",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":3767,tag:["-c"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgb35f898",properties:{"post-blank":0,"post-affiliated":3778},contents:["Compile to target language source files (.c, .js, ...)\n"]}]},{$$data_type:"org-node",type:"item",ref:"org313a748",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":3833,tag:["-o"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgd955a47",properties:{"post-blank":0,"post-affiliated":3844},contents:["Output to this file please\n"]}]}]},{$$data_type:"org-node",type:"src-block",ref:"org148340f",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gsc -verbose -target js -c -o hello-world-rt.js static/hello-world-rt.scm\n","post-blank":1,"post-affiliated":3873},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org7295837",properties:{"post-blank":1,"post-affiliated":3976},contents:["That leaves us with a very small runtime! ",{$$data_type:"org-node",type:"code",ref:"orge50ea20",properties:{value:"8k","post-blank":0},contents:[]},".\n"]},{$$data_type:"org-node",type:"src-block",ref:"orga766860",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"du hello-world-rt.js -h\n# 8.0K    hello-world-rt.js\n","post-blank":1,"post-affiliated":4025},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgdd4a383",properties:{"post-blank":1,"post-affiliated":4106},contents:["It doesn't actually do anything. A simple gerbil file that allows us to ",{$$data_type:"org-node",type:"code",ref:"orge26d3c9",properties:{value:"alert","post-blank":0},contents:[]},"\nwith a message from ",{$$data_type:"org-node",type:"code",ref:"orgd7189fc",properties:{value:"js","post-blank":0},contents:[]},", AKA ",{$$data_type:"org-node",type:"code",ref:"org2621da3",properties:{value:"host","post-blank":1},contents:[]},"will be our first attempt at ",{$$data_type:"org-node",type:"bold",ref:"org8ed376b",properties:{"post-blank":0},contents:["FFI"]},".\n"]},{$$data_type:"org-node",type:"src-block",ref:"org12f8726",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'(import :gerbil/gambit)\n(declare (extended-bindings))\n\n(def (alert str)\n  (##inline-host-statement "alert(\'Hello!! \' + g_scm2host(@1@));" str))\n\n(##inline-host-statement\n "exports.Hello = (arg) => {\n   var hello_fn = g_scm2host(@1@)\n   hello_fn(arg)\n}"\n (lambda (str) (alert str)))\n',"post-blank":1,"post-affiliated":4260},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org7443cd3",properties:{"post-blank":1,"post-affiliated":4572},contents:["That introduces functions.\n"]},{$$data_type:"org-node",type:"plain-list",ref:"org23481c5",properties:{type:"descriptive",structure:[[4600,2,"- ",null,null,"~##inline-host-statement~",4791],[4791,2,"- ",null,null,"g_scm2host(...)",4907]],"post-blank":1,"post-affiliated":4600},contents:[{$$data_type:"org-node",type:"item",ref:"org0f0f44f",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":4600,tag:[{$$data_type:"org-node",type:"code",ref:"orgbda441f",properties:{value:"##inline-host-statement","post-blank":0},contents:[]}]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org558fd25",properties:{"post-blank":0,"post-affiliated":4633},contents:["A scheme function that takes a constant string\nand optionally arguments to place inside that statement that are marked with the ",{$$data_type:"org-node",type:"code",ref:"orgc7d8063",properties:{value:"@N@","post-blank":1},contents:[]},"replacement string.\n"]}]},{$$data_type:"org-node",type:"item",ref:"orgf4eff6b",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":4791,tag:["g",{$$data_type:"org-node",type:"subscript",ref:"org58cc43c",properties:{"use-brackets-p":!1,"post-blank":0},contents:["scm2host"]},"(...)"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orga5d3163",properties:{"post-blank":0,"post-affiliated":4814},contents:["A ",{$$data_type:"org-node",type:"code",ref:"orgb54829d",properties:{value:"js","post-blank":1},contents:[]},"function which takes a scheme primitive and turns\nit into a javascript primitive.\n"]}]}]},{$$data_type:"org-node",type:"paragraph",ref:"orgaaf28b9",properties:{"post-blank":1,"post-affiliated":4908},contents:["Let's make it into a ",{$$data_type:"org-node",type:"code",ref:"org9e87485",properties:{value:"js","post-blank":1},contents:[]},"file! First the normal ",{$$data_type:"org-node",type:"code",ref:"orgaee0fe8",properties:{value:"gxc","post-blank":0},contents:[]},"\n"]},{$$data_type:"org-node",type:"src-block",ref:"org9ba36d6",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gxc -d . -S -static hello-world.ss\nrm hello-world.ssi\n","post-blank":1,"post-affiliated":4964},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org5c647f7",properties:{"post-blank":1,"post-affiliated":5047},contents:["And now for something different.\n"]},{$$data_type:"org-node",type:"plain-list",ref:"org967d517",properties:{type:"descriptive",structure:[[5081,2,"- ",null,null,"- l hello-world-rt",5154],[5154,2,"- ",null,null,"-exe",5225]],"post-blank":1,"post-affiliated":5081},contents:[{$$data_type:"org-node",type:"item",ref:"org76d9c82",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":5081,tag:["- l hello-world-rt"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org9b167f9",properties:{"post-blank":0,"post-affiliated":5107},contents:["Link to our runtime as the base library to use\n"]}]},{$$data_type:"org-node",type:"item",ref:"org4d48757",properties:{bullet:"- ",checkbox:null,counter:null,"pre-blank":0,"post-blank":0,"post-affiliated":5154,tag:["-exe"]},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org25a3b26",properties:{"post-blank":0,"post-affiliated":5166},contents:["Output an executable file that contains everything needed.\n"]}]}]},{$$data_type:"org-node",type:"src-block",ref:"org1648cc5",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gsc -target js -l hello-world-rt -exe -o hello-world.js static/hello-world.scm\ncp hello-world.js ../public/\n","post-blank":1,"post-affiliated":5226},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org96d107c",properties:{"post-blank":2,"post-affiliated":5363},contents:["The generated JS does not pass ",{$$data_type:"org-node",type:"code",ref:"org0a82f78",properties:{value:"eslint","post-blank":0},contents:[]},", and we have that set up for quasar in\norder to be dev friendly.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org3035c2d",properties:{"post-blank":1,"post-affiliated":5470},contents:["Let's get rid of eslint for that public directory. Look for this in\n",{$$data_type:"org-node",type:"code",ref:"orga2cad11",properties:{value:"quasar.conf.js","post-blank":1},contents:[]},"and edit the exclude.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgc05f8fd",properties:{language:"js",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"// https://quasar.dev/quasar-cli/handling-webpack\nextendWebpack (cfg) {\n  cfg.module.rules.push({\n    enforce: 'pre',\n    test: /\\.(js|vue)$/,\n    loader: 'eslint-loader',\n    exclude: /(node_modules|public)/\n  })\n}\n","post-blank":2,"post-affiliated":5578},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org471abce",properties:{"post-blank":1,"post-affiliated":5821},contents:["Everything is now For The Web! So let's make a ",{$$data_type:"org-node",type:"bold",ref:"orgeb41d56",properties:{"post-blank":1},contents:["Quasar"]},"page that hellos our\nworld.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org9621f5d",properties:{language:"vue",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"<template>\n  <q-page class=\"flex flex-center\">\n    <q-btn color=\"red\" @click=\"Hello('World!')\"> Hello World</q-btn>\n  </q-page>\n</template>\n\n<script>\nimport { Hello } from 'app/public/hello-world.js'\nexport default {\n  name: 'PageIndex',\n  methods: {\n    Hello (arg) {\n      Hello(arg)\n    }\n  }\n}\n<\/script>\n","post-blank":1,"post-affiliated":5906},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org62a1150",properties:{"post-blank":1,"post-affiliated":6241},contents:["It actually works! for ",{$$data_type:"org-node",type:"code",ref:"orgd322ffa",properties:{value:"20k","post-blank":1},contents:[]},"I can have scheme in the browser. That means a lot!\n"]},{$$data_type:"org-node",type:"src-block",ref:"org9658fb0",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"du -h hello-world.js\n# 20.0K   hello-world.js\n","post-blank":0,"post-affiliated":6323},contents:[]}]}]}]},{$$data_type:"org-node",type:"headline",ref:"org8fa00bd",drawer:{},properties:{"tags-all":[],"raw-value":"~hello-gxjs-rt~: Things get a little harder.","pre-blank":1,level:1,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":6398,title:[{$$data_type:"org-node",type:"code",ref:"org8f0a206",properties:{value:"hello-gxjs-rt","post-blank":0},contents:[]},": Things get a little harder."]},contents:[{$$data_type:"org-node",type:"section",ref:"orgfb1dd8c",properties:{"post-blank":2,"post-affiliated":6446},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org80d0bac",properties:{"post-blank":1,"post-affiliated":6446},contents:["One thing I desire is the ability to load on demand as well as use both languages the way they are meant to be used. Anyone familiar with ",{$$data_type:"org-node",type:"bold",ref:"org89a15fb",properties:{"post-blank":1},contents:["FFI"]},"knows this is never easy.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org9f70bee",properties:{"post-blank":1,"post-affiliated":6617},contents:["In this case the first thing that pops up is ",{$$data_type:"org-node",type:"bold",ref:"orgc23ba8b",properties:{"post-blank":0},contents:["modules"]},". ",{$$data_type:"org-node",type:"code",ref:"org5ee45f8",properties:{value:"js","post-blank":1},contents:[]},"has them, ",{$$data_type:"org-node",type:"code",ref:"orgbdf6720",properties:{value:"gerbil","post-blank":1},contents:[]},"has them, ",{$$data_type:"org-node",type:"code",ref:"orge963ca4",properties:{value:"gambit","post-blank":1},contents:[]},"has them, and they all differ.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"orgb0da2d7",properties:{"post-blank":1,"post-affiliated":6748},contents:["Because we want to use ",{$$data_type:"org-node",type:"code",ref:"orge74c736",properties:{value:"gerbil","post-blank":1},contents:[]},"and ",{$$data_type:"org-node",type:"code",ref:"org994b523",properties:{value:"js","post-blank":1},contents:[]},"with ",{$$data_type:"org-node",type:"code",ref:"orgf21b3ef",properties:{value:"gambit","post-blank":1},contents:[]},"being a distant cousin we\nhave to mess around.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgae88de5",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'namespace: gxjs\n(declare (extended-bindings))\n\n(def (alert thing) (##inline-host-statement "var foo = (@1@);\n  var bar = typeof foo === \'string\' ? foo : g_scm2host(foo)\n  alert(bar);" thing))\n(def (console.log obj) (##inline-host-statement "console.log((@1@))" obj))\n\n(def (gambit-module-name mod)\n  (def obj (##vector-ref (##vector-ref mod 0) 0))\n  (##inline-host-expression "(@1@).name" obj))\n\n(def (init-gambit-module mod)\n  (let ((init (##vector-ref mod 4)))\n    (if (not (##procedure? init)) (error "No init for " mod)\n      (init))))\n\n(define (init-gambit-program)\n  (declare (extended-bindings) (not safe))\n    (let ((mods (##vector-ref ##program-descr 0)))\n      (let loop ((i 1)) ;; start at module after the current one\n\t(if (##fx< i (##vector-length mods))\n\t    (let ((mod (##vector-ref mods i)))\n\t      (init-gambit-module mod) ;; call module\'s init procedure\n\t      (loop (##fx+ i 1)))))))\n\n(init-gambit-program)\n\n(##inline-host-declaration "\ngx_old_module_register = g_module_register;\n\ngx_gambit_module_table = [];\n\ngx_gambit_module_init = function (m) { alert(\'gx_gambit_module_init undefined\') }\n\ngx_gambit_module_register = function (module_descr) {\n  gx_gambit_module_table.push(module_descr);\n  typeof g_glo[\'##program-descr\'] === \'object\' ? gx_gambit_module_init(module_descr)\n    : gx_old_module_register(module_descr)\n}\n\ng_module_register = gx_gambit_module_register;\n\nconsole.log(g_module_register);\n\n")\n\n(##inline-host-statement "gx_gambit_module_init = (g_scm2host(@1@))" (lambda (mod) (init-gambit-module mod)))\n',"post-blank":0,"post-affiliated":6851},contents:[]}]},{$$data_type:"org-node",type:"headline",ref:"org72b0cc6",drawer:{},properties:{"tags-all":[],"raw-value":"~hello.ss~ a Gerbil scheme file with our new runtime lib","pre-blank":1,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":8421,title:[{$$data_type:"org-node",type:"code",ref:"org93c3b59",properties:{value:"hello.ss","post-blank":1},contents:[]},"a Gerbil scheme file with our new runtime lib"]},contents:[{$$data_type:"org-node",type:"section",ref:"orge813518",properties:{"post-blank":1,"post-affiliated":8482},contents:[{$$data_type:"org-node",type:"src-block",ref:"orgab9dbdc",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"(declare (extended-bindings))\n(extern namespace: gxjs alert)\n\n(##inline-host-statement\n \"exports.Hello = (arg) => {\n   var hello_fn = g_scm2host(@1@)\n   hello_fn('Hello ' + arg)\n}\"\n (lambda (str) (alert str)))\n","post-blank":0,"post-affiliated":8482},contents:[]}]}]},{$$data_type:"org-node",type:"headline",ref:"org8703c96",drawer:{},properties:{"tags-all":[],"raw-value":"~gambit-module-test.ss~: A module not loaded in the gambit program","pre-blank":1,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":8722,title:[{$$data_type:"org-node",type:"code",ref:"org3b1e0ff",properties:{value:"gambit-module-test.ss","post-blank":0},contents:[]},": A module not loaded in the gambit program"]},contents:[{$$data_type:"org-node",type:"section",ref:"org65bbefa",properties:{"post-blank":1,"post-affiliated":8793},contents:[{$$data_type:"org-node",type:"src-block",ref:"orgcd389b7",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'(declare (extended-bindings))\n(extern namespace: gxjs alert console.log)\n\n(##inline-host-statement\n "exports.Test = (arg) => {\n   var hello_fn = g_scm2host(@1@)\n   hello_fn(\'Test\' + arg)\n}"\n (lambda (str)\n   (let* ((mod (##inline-host-expression "gx_gambit_module_table[1];"))\n\t  (name (gxjs#gambit-module-name mod)))\n     (console.log mod)\n\n     (alert str) (alert name))))\n',"post-blank":0,"post-affiliated":8793},contents:[]}]}]},{$$data_type:"org-node",type:"headline",ref:"orgd91bdad",drawer:{},properties:{"tags-all":[],"raw-value":"Now compilation to different ~js~ files!","pre-blank":1,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":9198,title:["Now compilation to different ",{$$data_type:"org-node",type:"code",ref:"org4387504",properties:{value:"js","post-blank":1},contents:[]},"files!"]},contents:[{$$data_type:"org-node",type:"section",ref:"org7fdf70d",properties:{"post-blank":1,"post-affiliated":9243},contents:[{$$data_type:"org-node",type:"src-block",ref:"orga80fe43",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gxc -v -d . -S -static hello-gxjs-rt.ss\ngxc -v -d . -S -static hello.ss\ngxc -v -d . -S -static gambit-module-test.ss\n\ngsc -target js -c -o hello-gxjs-rt.js static/hello-gxjs-rt.scm\ngsc -target js -o hello-gxjs.js -exe -l hello-gxjs-rt static/hello.scm\n\n# Now output the modules test as a standalone\ngsc -target js -o gambit-module-test.js static/gambit-module-test.scm\n\n# and copy to public\n\ncp hello-gxjs.js gambit-module-test.js ../public\n\n","post-blank":0,"post-affiliated":9243},contents:[]}]}]},{$$data_type:"org-node",type:"headline",ref:"orgdd6b500",drawer:{},properties:{"tags-all":[],"raw-value":"The new ~Index.vue~","pre-blank":2,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":0,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":9714,title:["The new ",{$$data_type:"org-node",type:"code",ref:"org7b3d443",properties:{value:"Index.vue","post-blank":0},contents:[]}]},contents:[{$$data_type:"org-node",type:"section",ref:"org507ad10",properties:{"post-blank":1,"post-affiliated":9739},contents:[{$$data_type:"org-node",type:"src-block",ref:"orgca0f361",properties:{language:"vue",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"<template>\n  <q-page class=\"flex flex-center\">\n    <q-btn color=\"red\" @click=\"Hello('World! Tangle!')\"> Hello World</q-btn>\n    <q-btn color=\"red\" @click=\"Test('World! Tangle!')\"> Test function</q-btn>\n  </q-page>\n</template>\n\n<script>\n\nimport { Hello } from 'app/public/hello-gxjs.js'\n\nimport { Test } from 'app/public/gambit-module-test.js'\n\nwindow.Hello = Hello\nwindow.Test = Test\n\nexport default {\n  name: 'PageIndex',\n  methods: {\n    Hello (arg) {\n      console.log(Hello)\n      if (typeof Hello === 'function') { Hello('Hello: ' + arg) }\n    },\n    Test (arg) {\n      console.log(Test)\n      if (typeof Test === 'function') { Test('Test: ' + arg) }\n    }\n  }\n}\n<\/script>\n","post-blank":0,"post-affiliated":9739},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org61662a8",properties:{"post-blank":0,"post-affiliated":10443},contents:["And it works! Yay!\n"]}]}]}]},{$$data_type:"org-node",type:"headline",ref:"orgc38776f",drawer:{},properties:{"tags-all":[],"raw-value":"Full on *Gambit Scheme*","pre-blank":1,level:1,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":2,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":10463,title:["Full on ",{$$data_type:"org-node",type:"bold",ref:"orge67c610",properties:{"post-blank":0},contents:["Gambit Scheme"]}]},contents:[{$$data_type:"org-node",type:"section",ref:"org5b04a3d",properties:{"post-blank":2,"post-affiliated":10490},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org49d34a1",properties:{"post-blank":2,"post-affiliated":10490},contents:[{$$data_type:"org-node",type:"link",ref:"org31be02b",properties:{type:"https",path:"//udem-dlteam.github.io/webapp-tutorial/",format:"plain","raw-link":"https://udem-dlteam.github.io/webapp-tutorial/",application:null,"search-option":null,"post-blank":1,"is-internal":!1,"target-ref":null,"is-inline-image":!1},contents:[]},"and\n",{$$data_type:"org-node",type:"link",ref:"orga61150f",properties:{type:"https",path:"//github.com/udem-dlteam/webapp-tutorial",format:"plain","raw-link":"https://github.com/udem-dlteam/webapp-tutorial",application:null,"search-option":null,"post-blank":1,"is-internal":!1,"target-ref":null,"is-inline-image":!1},contents:[]},"are wonderful places to start. It\nbasically shows we can have a full gambit-in-browser.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"orgd3cd556",properties:{"post-blank":1,"post-affiliated":10678},contents:["Let's build our hello with a full gambit and see.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgaf95af1",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"bash <<EOF\ngxc -v -d . -S -static gambit-hello-world.ss\ngxc -v -d . -S -static gambit-hello-world-module-test.ss\ngsc -target js -exe -o gambit-hello-world.js static/gambit-hello-world.scm\ngsc -target js -o gambit-hello-world-module-test.js static/gambit-hello-world-module-test.scm\ncp gambit-hello-world*.js ../public/\nEOF\n","post-blank":1,"post-affiliated":10729},contents:[]},{$$data_type:"org-node",type:"src-block",ref:"orgc60e51a",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'(import :gerbil/gambit)\n(declare (extended-bindings))\n\n(##inline-host-statement\n "exports.Hello = (arg) => {\n  alert(\'Hello \' + arg)\n}"\n)\n\n(define (document.getElementById id)\n  (##inline-host-expression "g_host2foreign(document.getElementById(g_scm2host(@1@)))" id))\n\n(define (Element.innerText-ref elem)\n  (##inline-host-expression "g_host2scm(g_foreign2host(@1@).innerText)" elem))\n\n(define (sourceCodeRun id)\n  (let* ((elem (document.getElementById id))\n\t (code (Element.innerText-ref elem)))\n    (let ((expr (cons \'##begin (with-input-from-string code read-all))))\n      (eval expr))\n\n    ))\n\n(def (init-gambit-module mod)\n  (let ((init (##vector-ref mod 4)))\n    (if (not (##procedure? init)) (error "No init for " mod)\n      (init))))\n\n(##inline-host-declaration "\ngx_old_module_register = g_module_register;\n\ngx_gambit_module_table = [];\n\ngx_gambit_module_init = function (m) { alert(\'gx_gambit_module_init undefined\') }\n\ngx_gambit_module_register = function (module_descr) {\n  gx_gambit_module_table.push(module_descr);\n  typeof g_glo[\'##program-descr\'] === \'object\' ? gx_gambit_module_init(module_descr)\n    : gx_old_module_register(module_descr)\n}\n\ng_module_register = gx_gambit_module_register;\n\nconsole.log(g_module_register);\n\n")\n\n(##inline-host-statement "gx_gambit_module_init = (g_scm2host(@1@))" (lambda (mod) (init-gambit-module mod)))\n\n\n(##inline-host-declaration "g_sourceCodeRun = function () { alert(\'sourceCodeRun\'); };")\n\n(##inline-host-statement "g_sourceCodeRun = g_scm2host(@1@);" sourceCodeRun)\n\n',"post-blank":1,"post-affiliated":11081},contents:[]},{$$data_type:"org-node",type:"src-block",ref:"org4c9b925",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"(declare (extended-bindings))\n(##inline-host-statement\n \"exports.Test = (arg) => {\n  alert('Test' + arg)\n}\"\n)\n","post-blank":1,"post-affiliated":12636},contents:[]},{$$data_type:"org-node",type:"src-block",ref:"orgf61e349",properties:{language:"vue",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"<template>\n  <q-page>\n    <q-btn color=\"red\" @click=\"Hello('WOrld! Tahgle!')\"> Hello World</q-btn>\n    <q-btn color=\"red\" @click=\"Test('WOrld! Tahgle!')\"> Test function</q-btn>\n    <br>\n    <div class=\"full-width\" contenteditable=\"true\" id=\"gx_repl\" style=\"max-width: 300px; height: 25vh; border: 2px solid black;\">\n    534\n   </div>\n    <q-btn color=\"red\" @click=\"sourceCodeRun('gx_repl')\"> Repl </q-btn>\n  </q-page>\n</template>\n\n<script>\n\nimport { Hello } from 'app/public/gambit-hello-world.js'\n\nimport { Test } from 'app/public/gambit-hello-world-module-test.js'\n\nwindow.Hello = Hello\nwindow.Test = Test\n\nexport default {\n  name: 'PageIndex',\n  methods: {\n    Hello (arg) {\n      console.log(Hello)\n      if (typeof Hello === 'function') { Hello('Hello: ' + arg) }\n    },\n    Test (arg) {\n      console.log(Test)\n      if (typeof Test === 'function') { Test('Test: ' + arg) }\n    },\n    sourceCodeRun (id) {\n      var val = g_sourceCodeRun(id)\n      alert('=>' + val)\n    }\n  }\n}\n<\/script>\n","post-blank":0,"post-affiliated":12776},contents:[]}]}]},{$$data_type:"org-node",type:"headline",ref:"org3e24d6d",drawer:{},properties:{"tags-all":[],"raw-value":"Lazy-load ~_gambit.js~.","pre-blank":1,level:1,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":0,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":13798,title:["Lazy-load ",{$$data_type:"org-node",type:"code",ref:"org389d6ca",properties:{value:"_gambit.js","post-blank":0},contents:[]},"."]},contents:[{$$data_type:"org-node",type:"section",ref:"org68bbce6",properties:{"post-blank":1,"post-affiliated":13825},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgf65264e",properties:{"post-blank":2,"post-affiliated":13825},contents:["That works as well. So, now, an attempt to make the Gambit ",{$$data_type:"org-node",type:"code",ref:"orga344eff",properties:{value:"_gambit","post-blank":1},contents:[]},"module\nbecome a dynamically loaded ",{$$data_type:"org-node",type:"code",ref:"org3516f2d",properties:{value:"js","post-blank":1},contents:[]},"module.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgf9cb641",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'(import :gerbil/gambit)\n(declare (extended-bindings))\n\n(##inline-host-statement\n "exports.evalElement = (arg) => {\n  alert(\'Lazy? Hello \' + arg)\n}"\n)\n\n(define (document.getElementById id)\n  (##inline-host-expression "g_host2foreign(document.getElementById(g_scm2host(@1@)))" id))\n\n(define (Element.innerText-ref elem)\n  (##inline-host-expression "g_host2scm(g_foreign2host(@1@).innerText)" elem))\n\n(define (sourceCodeRun id)\n  (let* ((elem (document.getElementById id))\n\t (code (Element.innerText-ref elem)))\n    (let ((expr (cons \'##begin (with-input-from-string code read-all))))\n      (eval expr))\n\n    ))\n\n(##inline-host-declaration "g_sourceCodeRun = function () { alert(\'sourceCodeRun\'); };")\n\n(##inline-host-statement "g_sourceCodeRun = g_scm2host(@1@);" sourceCodeRun)\n\n',"post-blank":0,"post-affiliated":13944},contents:[]}]},{$$data_type:"org-node",type:"headline",ref:"orgdd4f5d9",drawer:{},properties:{"tags-all":[],"raw-value":"First attempt","pre-blank":1,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":14752,title:["First attempt"]},contents:[{$$data_type:"org-node",type:"section",ref:"org403cf33",properties:{"post-blank":1,"post-affiliated":14770},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org807ee2f",properties:{"post-blank":1,"post-affiliated":14770},contents:["We'll simply try to insert it at the end of our custom run-time. It does not\nactually work but gives us great insights as to why.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgf47b4ce",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"bash <<'EOF'\n gxc -v -d . -S -static hello-gxjs-rt.ss\n gxc -v -d . -S -static hello.ss\n gxc -v -d . -S -static gambit-module-test.ss\n gxc -v -d . -S -static lazy-gambit-repl.ss\n\n gsc -target js -c -o hello-gxjs-rt.js static/hello-gxjs-rt.scm\n gsc -target js -o hello-gxjs.js -exe -l hello-gxjs-rt static/hello.scm\n\n # Now output the modules test as a standalone\n gsc -target js -o gambit-module-test.js static/gambit-module-test.scm\n\n # Ok, now the lazy gambit repl\n gsc -target js -o lazy-gambit-repl.js static/lazy-gambit-repl.scm\n\n # and copy to public, including the _gambit.js\n\n _gambit_js=$(gsc -e '(display (path-expand \"~~lib/\"))')/_gambit.js;\n _cp=\"cp hello-gxjs.js lazy-gambit-repl.js gambit-module-test.js $_gambit_js ../public\";\n echo Copy $_cp; $_cp\n\nEOF\n","post-blank":1,"post-affiliated":14901},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org12fae01",properties:{"post-blank":0,"post-affiliated":15698},contents:["It fails in the browser with\n"]},{$$data_type:"org-node",type:"fixed-width",ref:"orgbcdb1a6",properties:{value:"ReferenceError: G_Bignum is not defined","post-blank":2,"post-affiliated":15727},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org4dcf8f7",properties:{"post-blank":1,"post-affiliated":15773},contents:["Is that because our runtime lib does not require that but _gambit.js does? We'll\nuse the ",{$$data_type:"org-node",type:"code",ref:"orge92dcaa",properties:{value:"-verbose","post-blank":1},contents:[]},"and ",{$$data_type:"org-node",type:"code",ref:"org3204b74",properties:{value:"-keep-temp","post-blank":1},contents:[]},"flags to find out.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orga90a484",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"bash <<'EOF'\n\n gxc -v -d . -S -static hello-gxjs-rt.ss\n gxc -v -d . -S -static hello.ss\n gxc -v -d . -S -static gambit-module-test.ss\n gxc -v -d . -S -static lazy-gambit-repl.ss\n gxc -v -d . -S -static gambit-hello-world-module-test.ss\n gxc -v -d . -S -static gambit-hello-world.ss\n\n gsc -target js -o gambit-hello-world-module-test.js static/gambit-hello-world-module-test.scm\n\n # Now output the modules test as a standalone\n gsc -target js -o gambit-module-test.js static/gambit-module-test.scm\n\n # Ok, now the lazy gambit repl\n gsc -target js -o lazy-gambit-repl.js static/lazy-gambit-repl.scm\n\n gsc -verbose -keep-temp -target js -exe -o gambit-hello-world.js static/gambit-hello-world.scm\n\n gsc -verbose -keep-temp -target js -o hello-gxjs.js -exe -l hello-gxjs-rt static/hello.scm\nEOF\n","post-blank":1,"post-affiliated":15910},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org1807ead",properties:{"post-blank":1,"post-affiliated":16730},contents:["That ends up giving us some interesting details.\n"]},{$$data_type:"org-node",type:"fixed-width",ref:"org6d9621a",properties:{value:'cat static/gambit-hello-world_.o static/gambit-hello-world.o "/nix/store/48ksq09y70dz19dyf8i411js6li9i968-gambit-unstable-2020-10-27/gambit/lib/_gambit.js" > "gambit-hello-world.js"\ncat static/hello_.o static/hello.o "hello-gxjs-rt.js" > "hello-gxjs.js"',"post-blank":2,"post-affiliated":16780},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgcc2b3f7",properties:{"post-blank":1,"post-affiliated":17045},contents:["The ",{$$data_type:"org-node",type:"code",ref:"org9c7d4b7",properties:{value:"*_.o","post-blank":1},contents:[]},"files are generated by the complier. Here are the options.\n"]},{$$data_type:"org-node",type:"quote-block",ref:"orgbd5a884",properties:{"post-blank":1,"post-affiliated":17119},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgf5b1a78",properties:{"post-blank":0,"post-affiliated":17136},contents:["Output mode\n -target l   Select target language to compile to (C, js, x86-64, ...)\n -c          Compile to target language source files (.c, .js, ...)\n -link       Generate a link file combining a set of compiled files\n -obj        Compile to object files (.o, .obj)\n -exe        Compile to an executable program or script\n -dynamic    Compile to a .oN dynamically loadable file (default mode)\n"]}]},{$$data_type:"org-node",type:"paragraph",ref:"orgbf90ab0",properties:{"post-blank":1,"post-affiliated":17567},contents:["Interesting! What happens with ",{$$data_type:"org-node",type:"code",ref:"orgeca4569",properties:{value:"-link","post-blank":0},contents:[]},"?\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgb20a47b",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'   gsc -verbose -keep-temp -target js -link -o gambit-hello-world-link.js static/gambit-hello-world.scm\n\n   # This does not have any files to "-keep-temp"! That\'s a good thing.\n\n   wc gambit-hello-world-link.js static/gambit-hello-world_.js\n\t1518      8271    112123 gambit-hello-world-link.js\n\t1518      8271    112119 static/gambit-hello-world_.js\n\t3036     16542    224242 total\n\n',"post-blank":1,"post-affiliated":17611},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org1a6e430",properties:{"post-blank":1,"post-affiliated":18029},contents:["That's brilliant. 4 char difference? Hmmmm.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org82b04ab",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:" bash <<'EOF'\n_lnk='gambit-hello-world-link'\n_under='gambit-hello-world_'\n\necho char diff? => $(expr `echo $_lnk | wc -c` - `echo $_under |wc -c`)\n>\nEOF\n\n  # char diff? => 4\n\n","post-blank":1,"post-affiliated":18074},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org40d6e30",properties:{"post-blank":1,"post-affiliated":18278},contents:["Beyond the file name they are identical as a ",{$$data_type:"org-node",type:"code",ref:"org54d7e2c",properties:{value:"diff","post-blank":1},contents:[]},"shows us.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"orgca78a44",properties:{"post-blank":1,"post-affiliated":18341},contents:["The differences between those and our ",{$$data_type:"org-node",type:"code",ref:"org3477e12",properties:{value:"hello_.js","post-blank":1},contents:[]},"generated link file are\nimmense.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org37ce912",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"du -k gambit-hello-world-link.js static/hello_.js\n# 112     gambit-hello-world-link.js\n# 12      static/hello_.js\n\n","post-blank":1,"post-affiliated":18425},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org0cda10a",properties:{"post-blank":1,"post-affiliated":18569},contents:["An extra 100k is a hellovalot. Can that one work with our existing hello?\n"]},{$$data_type:"org-node",type:"paragraph",ref:"orgc127744",properties:{"post-blank":1,"post-affiliated":18644},contents:["A quick ",{$$data_type:"org-node",type:"code",ref:"org9a4002c",properties:{value:"diff gambit-hello-world-link.js static/hello_.js","post-blank":1},contents:[]},"has almost all ",{$$data_type:"org-node",type:"code",ref:"org49639d5",properties:{value:"-","post-blank":0},contents:[]},"\nlines besides the second line which is a comment that Gambit generates/uses and\nthe last line.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org204594b",properties:{"post-blank":1,"post-affiliated":18818},contents:["The last line is likely the crucial one. With a wee bit of know-how about how\ngambit modules run/interact etc it makes perfect sense.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgbbcbe1c",properties:{language:"diff",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'-g_module_registry_init([new G_ModLinkInfo("_gambit",0),new G_ModLinkInfo("gambit-hello-world",1)]);\n+g_module_registry_init([new G_ModLinkInfo("hello-gxjs-rt",0),new G_ModLinkInfo("hello",1)]);\n',"post-blank":1,"post-affiliated":18953},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgf0b9bf5",properties:{"post-blank":1,"post-affiliated":19176},contents:['A different module registry seems to define when/how/if a "module" is\ninitialized by the run time.\n']},{$$data_type:"org-node",type:"paragraph",ref:"orgaeadde6",properties:{"post-blank":1,"post-affiliated":19276},contents:["Here is the ",{$$data_type:"org-node",type:"code",ref:"org79ae79e",properties:{value:"js","post-blank":0},contents:[]},".\n"]},{$$data_type:"org-node",type:"src-block",ref:"org432ca45",properties:{language:"javascript",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"g_module_registry_init = function (link_info) {\n  var n = link_info.length;\n  var i = 0;\n  g_module_table = new Array(n);\n  while (i < n) {\n    var info = link_info[i];\n    g_module_map[info.name] = info;\n    g_module_table[i] = null;\n    ++i;\n  }\n};\n","post-blank":1,"post-affiliated":19295},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org4809bfb",properties:{"post-blank":1,"post-affiliated":19580},contents:["Now every gambit module registers itself at the EOF.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org907b6ba",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"grep '^g_module_register' static/hello.js\ng_module_register([[g_make_interned_symbol(\"hello\")],[],null,1,g_bb1_hello_23_,false]);\n","post-blank":1,"post-affiliated":19634},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org9877ce8",properties:{"post-blank":1,"post-affiliated":19793},contents:["The source for that is brilliant as it tells me what I need to know and why we\nhad to init the way we did. The comments are all mine.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgac23f03",properties:{language:"javascript",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'g_module_register = function (module_descr) {\n\n  // The interned symbol of the name in an array\n\n  var temp = module_descr[0];\n\n  // the name of the module.\n  var name = temp[temp.length - 1].name;\n\n  // Search for it in the module registry by name.\n  var info = Object.prototype.hasOwnProperty.call(g_module_map,name) ? g_module_map[name] : null;\n\n  // Set the latest registered to this module\n  g_module_latest_registered = module_descr;\n\n  // If we are not waiting for this module OR we already have all we are waiting\n  // for, ignore it.\n\n  if (!(info === null || g_module_count === g_module_table.length)) {\n\n    // on initialization we gave this an index and a name.\n    var index = info.index;\n    // If this is already registered, let us know.\n    var old = g_module_table[index];\n\n    // regardless, this new module is in the table.\n\n    g_module_table[index] = module_descr;\n\n    // If there was no old, increase the count and continue.\n    if (old === null) {\n      ++g_module_count;\n      // If we have all the modules, let the program\n      if (g_module_count === g_module_table.length) {\n\t// set the global ##program-descr to an array of the module table and\n\t// two other things I do not understand.\n\tg_glo["##program-descr"] = [g_module_table,null,false];\n\n\t// This is the array of a symbol that names the last module in the\n\t// init.\n\ttemp = g_module_table[g_module_table.length - 1][0];\n\tg_glo["##vm-main-module-ref"] = temp[temp.length - 1];\n\n\t// I think this is the prefix to running a function via the trampoline\n\tg_sp = -1;\n\tg_stack[++g_sp] = void 0;\n\tg_r0 = g_underflow;\n\tg_nargs = 0;\n\n\t// This runs the init procedure of the first registry_init we specified.\n\n\tg_trampoline(g_module_table[0][4]);\n      }\n    }\n  }\n};\n\n',"post-blank":1,"post-affiliated":19928},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orge041e1a",properties:{"post-blank":3,"post-affiliated":21706},contents:["That helps a lot! We already test and initialize them on their own when the\nregistry is full. Knowing the order they are initialized we can simply replace\nthe init function.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org5ccef4d",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gxc -v -d . -S -static link-gxjs-rt.ss\ngxc -v -d . -S -static hello-world.ss\ngsc -target js -c -o link-gxjs-rt.js static/link-gxjs-rt.scm\ngsc -target js -l link-gxjs-rt -link -o link-hello-world.js static/hello-world.scm\n","post-blank":0,"post-affiliated":21883},contents:[]}]}]},{$$data_type:"org-node",type:"headline",ref:"orgcbcb6c3",drawer:{},properties:{"tags-all":[],"raw-value":"Second Attempt: Make/change link files.","pre-blank":1,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":22133,title:["Second Attempt: Make/change link files."]},contents:[{$$data_type:"org-node",type:"section",ref:"orgfbca907",properties:{"post-blank":1,"post-affiliated":22177},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgf45aae2",properties:{"post-blank":1,"post-affiliated":22177},contents:["First, our normal hello-gxjs\n"]},{$$data_type:"org-node",type:"src-block",ref:"org27b8ee7",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gxc -v -d . -S -static hello-gxjs-rt.ss\ngxc -v -d . -S -static hello.ss\ngxc -v -d . -S -static gambit-module-test.ss\ngxc -v -d . -S -static lazy-gambit-repl.ss\n","post-blank":1,"post-affiliated":22207},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org1fbf86f",properties:{"post-blank":0,"post-affiliated":22396},contents:["Now make a ",{$$data_type:"org-node",type:"code",ref:"orga823ea2",properties:{value:"-link","post-blank":1},contents:[]},"rather than an ",{$$data_type:"org-node",type:"code",ref:"org71ca772",properties:{value:"-exe","post-blank":0},contents:[]},'. We\'ll follow the gambit "end with _".\n']},{$$data_type:"org-node",type:"src-block",ref:"org2693d09",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gsc -target js -c -o hello-gxjs-rt.js static/hello-gxjs-rt.scm\ngsc -target js -o REMOVE-hello-gxjs_.js -link -l hello-gxjs-rt static/hello.scm\n_mod_init=\"$(grep -rE '^g_module_registry_init\\(' REMOVE-hello-gxjs_.js)\"\n\necho $_mod_init\n","post-blank":2,"post-affiliated":22476},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgbf6a241",properties:{"post-blank":1,"post-affiliated":22740},contents:["Time to create a ",{$$data_type:"org-node",type:"code",ref:"org1b45e7b",properties:{value:"-link","post-blank":1},contents:[]},"that includes all that ",{$$data_type:"org-node",type:"code",ref:"orgbfebb0a",properties:{value:"_gambit.js","post-blank":1},contents:[]},"seems to need. We replace the module",{$$data_type:"org-node",type:"subscript",ref:"orgf41a369",properties:{"use-brackets-p":!1,"post-blank":0},contents:["registry"]},{$$data_type:"org-node",type:"subscript",ref:"org6a259d3",properties:{"use-brackets-p":!1,"post-blank":1},contents:["init"]},"line.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org0ffd6fc",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'gsc -target js -o hello_.js -link static/hello.scm\nsed -i "s/^g_module_registry_init(.*/$_mod_init/" hello_.js\n',"post-blank":1,"post-affiliated":22859},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org75bf44a",properties:{"post-blank":1,"post-affiliated":22999},contents:["And compile the other modules.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orgeb0d7d3",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gsc -target js -o hello.js static/hello.scm\ngsc -target js -o gambit-module-test.js static/gambit-module-test.scm\ngsc -target js -o lazy-gambit-repl.js static/lazy-gambit-repl.scm\n","post-blank":1,"post-affiliated":23031},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgf0488e5",properties:{"post-blank":2,"post-affiliated":23240},contents:["Now the fun part. Earlier we saw that compilation can simply ",{$$data_type:"org-node",type:"code",ref:"org085a04a",properties:{value:"cat","post-blank":1},contents:[]},{$$data_type:"org-node",type:"code",ref:"orgfd51257",properties:{value:"js","post-blank":1},contents:[]},"files together.\n"]},{$$data_type:"org-node",type:"fixed-width",ref:"org014ad5d",properties:{value:'cat static/gambit-hello-world_.o static/gambit-hello-world.o "/nix/store/48ksq09y70dz19dyf8i411js6li9i968-gambit-unstable-2020-10-27/gambit/lib/_gambit.js" > "gambit-hello-world.js"\ncat static/hello_.o static/hello.o "hello-gxjs-rt.js" > "hello-gxjs.js"',"post-blank":2,"post-affiliated":23330},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org4dc4930",properties:{"post-blank":1,"post-affiliated":23595},contents:["Doing the same, what happens?\n"]},{$$data_type:"org-node",type:"src-block",ref:"org90eec75",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"cat hello_.js hello.js hello-gxjs-rt.js > hello-gxjs.js\n","post-blank":1,"post-affiliated":23626},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgffc9722",properties:{"post-blank":1,"post-affiliated":23711},contents:["For the lazy we'll do ",{$$data_type:"org-node",type:"code",ref:"org9bd0469",properties:{value:"_gambit.js","post-blank":1},contents:[]},"first as the loading and initialization is taken care of by us.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orga837c25",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"cat $(gsc -e '(display (path-expand \"~~lib/_gambit.js\"))') lazy-gambit-repl.js > gambit-repl.js\n","post-blank":1,"post-affiliated":23811},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org2521945",properties:{"post-blank":1,"post-affiliated":23936},contents:["It doesn't work.\n"]},{$$data_type:"org-node",type:"fixed-width",ref:"org9ab514c",properties:{value:"g_glo.##current-readtable is not a function","post-blank":2,"post-affiliated":23954},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org5b068a4",properties:{"post-blank":1,"post-affiliated":24004},contents:["That seems to be that although that is in ",{$$data_type:"org-node",type:"code",ref:"orgb8ca6e4",properties:{value:"_gambit.js","post-blank":1},contents:[]},"it's not loaded. Reversing the order as an exe does also fails.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org73094c6",properties:{"post-blank":0,"post-affiliated":24124},contents:["Hrm.\n"]}]}]},{$$data_type:"org-node",type:"headline",ref:"orgb903513",drawer:{},properties:{"tags-all":[],"raw-value":"Third Attempt: re-init registry","pre-blank":2,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":24130,title:["Third Attempt: re-init registry"]},contents:[{$$data_type:"org-node",type:"section",ref:"orgc43b56e",properties:{"post-blank":1,"post-affiliated":24167},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgb6d3c1c",properties:{"post-blank":2,"post-affiliated":24167},contents:["Compilation of an exe that contains all we want is a good start. Rather than our\nruntime we'll simply emulate the only thing ",{$$data_type:"org-node",type:"code",ref:"org666aebb",properties:{value:"hello.ss","post-blank":1},contents:[]},"uses in a ",{$$data_type:"org-node",type:"code",ref:"org26c42df",properties:{value:"gxsj-alert.ss","post-blank":1},contents:[]},"file.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org3b5f525",properties:{language:"scheme",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'namespace: gxjs\n(declare (extended-bindings))\n\n(def (alert thing) (##inline-host-statement "var foo = (@1@);\n  var bar = typeof foo === \'string\' ? foo : g_scm2host(foo)\n  alert(bar);" thing))\n(def (console.log obj) (##inline-host-statement "console.log((@1@))" obj))\n',"post-blank":1,"post-affiliated":24337},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org356cab3",properties:{"post-blank":1,"post-affiliated":24634},contents:["Ok, same as last time, ",{$$data_type:"org-node",type:"code",ref:"org5b06fe7",properties:{value:"gxc","post-blank":1},contents:[]},"everything.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orge5aa67a",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gxc -v -d . -S -static hello-gxjs-rt.ss\ngxc -v -d . -S -static gxjs-alert.ss\ngxc -v -d . -S -static hello.ss\ngxc -v -d . -S -static gambit-hello-world-module-test.ss\ngxc -v -d . -S -static lazy-gambit-repl.ss\n","post-blank":2,"post-affiliated":24676},contents:[]},{$$data_type:"org-node",type:"src-block",ref:"org77fdb66",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gsc -verbose -keep-temp -target js -exe -o gambit-nonlazy-hello.js static/gxjs-alert.scm static/hello.scm static/gambit-hello-world-module-test.scm static/lazy-gambit-repl.scm\ncp gambit-nonlazy-hello.js ../public/\n","post-blank":1,"post-affiliated":24915},contents:[]},{$$data_type:"org-node",type:"fixed-width",ref:"orgf5ac7ca",properties:{value:'=> cat static/lazy-gambit-repl_.o static/gxjs-alert.o static/hello.o static/gambit-hello-world-module-test.o static/lazy-gambit-repl.o "/nix/store/48ksq09y70dz19dyf8i411js6li9i968-gambit-unstable-2020-10-27/gambit/lib/_gambit.js" "gambit-nonlazy-hello.js"',"post-blank":3,"post-affiliated":25158},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org97cb0f5",properties:{"post-blank":1,"post-affiliated":25421},contents:["And try in in ",{$$data_type:"org-node",type:"code",ref:"org617fcca",properties:{value:"Index.vue","post-blank":0},contents:[]},".\n"]},{$$data_type:"org-node",type:"fixed-width",ref:"org13ac481",properties:{value:"import { Hello, Test } from 'app/public/gambit-nonlazy-hello.js'\n// This also imports all of _gambit.js","post-blank":2,"post-affiliated":25449},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgea13367",properties:{"post-blank":1,"post-affiliated":25562},contents:["A quick look says the link file is identical save for the registry init. That's a good thing. Oh, and it works.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org9719323",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"_nonlazy_link='static/lazy-gambit-repl_.o'\n_nonlazy_mod_init=\"$(grep -rE '^g_module_registry_init\\(' $_nonlazy_link)\"\n","post-blank":1,"post-affiliated":25675},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org786bab9",properties:{"post-blank":1,"post-affiliated":25822},contents:["So like last time we'll build one that was the init we want\n"]},{$$data_type:"org-node",type:"src-block",ref:"org81dadf9",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gsc -target js -c -o hello-gxjs-rt.js static/hello-gxjs-rt.scm\ngsc -target js -o REMOVE-hello-gxjs_.js -link -l hello-gxjs-rt static/hello.scm\n\n_hello_mod_init=\"$(grep -rE '^g_module_registry_init\\(' REMOVE-hello-gxjs_.js)\"\n\necho $_hello_mod_init\n","post-blank":1,"post-affiliated":25883},contents:[]},{$$data_type:"org-node",type:"src-block",ref:"orgfddba92",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'gsc -target js -o hello_.js -link static/hello.scm\nsed -i "s/^g_module_registry_init(.*/$_hello_mod_init/" hello_.js\ngsc -target js -o hello.js static/hello.scm\ncat hello_.js hello.js hello-gxjs-rt.js > hello-gxjs.js\ncp hello-gxjs.js ../public\n',"post-blank":1,"post-affiliated":26159},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org7734acc",properties:{"post-blank":1,"post-affiliated":26432},contents:["The entire reason behind this is after loading and initializing the module\nregistry it to reset the module registry and init it again.\n"]},{$$data_type:"org-node",type:"paragraph",ref:"orgcd2ca9e",properties:{"post-blank":0,"post-affiliated":26568},contents:["So, to reset it we'll try this:\n"]},{$$data_type:"org-node",type:"src-block",ref:"org012cb8d",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:'_mod_reset="$(grep \'^g_module_.* = [^f]\' hello_.js)"\n\n\necho  "$_mod_reset" > g-module-reset.js\n\n# g_module_count = 0;\n# g_module_map = {};\n# g_module_table = null;\n# g_module_latest_registered = null;\n\n',"post-blank":1,"post-affiliated":26600},contents:[]},{$$data_type:"org-node",type:"src-block",ref:"org75c4701",properties:{language:"javascript",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"g_module_count = 0;\ng_module_map = {};\ng_module_table = null;\ng_module_latest_registered = null;\n","post-blank":1,"post-affiliated":26831},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org42a9b3b",properties:{"post-blank":1,"post-affiliated":26962},contents:["Now for a re-init. First, what does the link want?\n"]},{$$data_type:"org-node",type:"src-block",ref:"org6b0e548",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gsc -target js -link -o gambit-repl_.js static/lazy-gambit-repl.scm\n_lazy_mod_init=\"$(grep -rE '^g_module_registry_init\\(' gambit-repl_.js)\"\necho $_lazy_mod_init > lazy-mod-init.js\necho \"delete g_glo['##program-descr']\" >> lazy-mod-init.js\n","post-blank":1,"post-affiliated":27014},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org6427588",properties:{"post-blank":2,"post-affiliated":27283},contents:["Compile the other modules\n"]},{$$data_type:"org-node",type:"src-block",ref:"org58735f5",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"gsc -target js -o gambit-module-test.js static/gambit-module-test.scm\ngsc -target js -o lazy-gambit-repl.js static/lazy-gambit-repl.scm\n","post-blank":0,"post-affiliated":27311},contents:[]},{$$data_type:"org-node",type:"src-block",ref:"org88cbb37",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"cat g-module-reset.js lazy-mod-init.js lazy-gambit-repl.js $(gsc -e '(display (path-expand \"~~lib/_gambit.js\"))')  > gambit-repl.js\ncp gambit-repl.js gambit-module-test.js ../public\n","post-blank":1,"post-affiliated":27475},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org46b37ca",properties:{"post-blank":1,"post-affiliated":27686},contents:["It works!!\n"]},{$$data_type:"org-node",type:"paragraph",ref:"orgefeab25",properties:{"post-blank":0,"post-affiliated":27698},contents:["We can now lazy-load anything it seems.\n"]}]}]},{$$data_type:"org-node",type:"headline",ref:"org14be516",drawer:{},properties:{"tags-all":[],"raw-value":"A new ~Index.vue~","pre-blank":1,level:2,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":0,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":27739,title:["A new ",{$$data_type:"org-node",type:"code",ref:"org07a260a",properties:{value:"Index.vue","post-blank":0},contents:[]}]},contents:[{$$data_type:"org-node",type:"section",ref:"orgbcafd8f",properties:{"post-blank":0,"post-affiliated":27761},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org8ae1f62",properties:{"post-blank":1,"post-affiliated":27761},contents:["This is what we end up with.\n"]},{$$data_type:"org-node",type:"src-block",ref:"org3f66eb5",properties:{language:"vue",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"<template>\n  <q-page class=\"flex flex-center\">\n    <q-btn color=\"red\" @click=\"Hello('WOrld! Tahgle!')\"> Hello World</q-btn>\n    <q-btn color=\"red\" @click=\"Test('WOrld! Tahgle!')\"> Test function</q-btn>\n    <br>\n    <div class=\"full-width\" contenteditable=\"true\" id=\"gx_repl\" style=\"max-width: 300px; height: 25vh; border: 2px solid black;\">\n    534\n   </div>\n    <q-btn color=\"red\" @click=\"sourceCodeRun('gx_repl')\"> Repl </q-btn>\n  </q-page>\n</template>\n\n<script>\n\n// import { Hello, Test } from 'app/public/gambit-nonlazy-hello.js'\n\nimport { Hello } from 'app/public/hello-gxjs.js'\nimport { Test } from 'app/public/gambit-module-test.js'\n\n// var Test = Hello\n\nimport 'app/public/gambit-repl.js'\n\nwindow.Hello = Hello\nwindow.Test = Test\n\nexport default {\n  name: 'PageIndex',\n  methods: {\n    Hello (arg) {\n      console.log(Hello)\n      if (typeof Hello === 'function') { Hello('Hello: ' + arg) }\n    },\n    Test (arg) {\n      console.log(Test)\n      if (typeof Test === 'function') { Test('Test: ' + arg) }\n    },\n    sourceCodeRun (id) {\n      var val = g_sourceCodeRun(id)\n      alert('=> ' + val)\n    }\n  }\n}\n<\/script>\n","post-blank":0,"post-affiliated":27791},contents:[]}]}]}]},{$$data_type:"org-node",type:"headline",ref:"org4a8c8ab",drawer:{},properties:{"tags-all":[],"raw-value":"Build and deploy the app","pre-blank":1,level:1,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":1,"footnote-section-p":!1,archivedp:!1,commentedp:!1,"post-affiliated":28942,title:["Build and deploy the app"]},contents:[{$$data_type:"org-node",type:"section",ref:"org1643368",properties:{"post-blank":1,"post-affiliated":28970},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org96601cf",properties:{"post-blank":1,"post-affiliated":28970},contents:["First we build!\n"]},{$$data_type:"org-node",type:"src-block",ref:"org05fd202",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"LD=$CC quasar build\n","post-blank":1,"post-affiliated":28987},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org6f94501",properties:{"post-blank":1,"post-affiliated":29036},contents:["Now make sure that if/when I fsck things up there's a backup.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orga74c326",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"cd ../; rsync -av gx-quasar/ gx-quasar-bak;  cd -\n","post-blank":1,"post-affiliated":29099},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"org0349d1c",properties:{"post-blank":1,"post-affiliated":29178},contents:["Now create a branch as an orphan.\n"]},{$$data_type:"org-node",type:"src-block",ref:"orge1b7bef",properties:{language:"shell",switches:null,parameters:null,"number-lines":null,"preserve-indent":!1,"retain-labels":!0,"use-labels":!0,"label-fmt":null,value:"git checkout --orphan gh-pages\ngit rm -rf .\n# rm 'LICENSE'\n# rm 'doc/log/0000_Getting-Started.org'\nrsync -av dist/spa/ .\ngit add css/ fonts/ js/ index.html\ngit commit -m \"First attempt at gh-pages\"\ngit push origin gh-pages\n","post-blank":1,"post-affiliated":29213},contents:[]},{$$data_type:"org-node",type:"paragraph",ref:"orgfc6cf7a",properties:{"post-blank":1,"post-affiliated":29465},contents:["A quick look says it's working quite well!\n"]},{$$data_type:"org-node",type:"paragraph",ref:"org63833fb",properties:{"post-blank":0,"post-affiliated":29509},contents:["That will end this logfile as we're up and running. Next up will be to make it\nuseful.\n"]}]}]},{$$data_type:"org-node",type:"headline",ref:"orgd348cd6",drawer:{},properties:{"tags-all":[],"raw-value":"Footnotes","pre-blank":1,level:1,priority:null,tags:[],"todo-keyword":null,"todo-type":null,"post-blank":0,"footnote-section-p":!0,archivedp:!1,commentedp:!1,"post-affiliated":29597,title:["Footnotes"]},contents:[{$$data_type:"org-node",type:"section",ref:"orga4d7f5f",properties:{"post-blank":0,"post-affiliated":29610},contents:[{$$data_type:"org-node",type:"footnote-definition",ref:"orgcdfc550",properties:{label:"4","pre-blank":0,"post-blank":1,"post-affiliated":29610},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org1c94b2a",properties:{"post-blank":0,"post-affiliated":29617},contents:[{$$data_type:"org-node",type:"link",ref:"orgf21257f",properties:{type:"http",path:"//gambitscheme.org/",format:"plain","raw-link":"http://gambitscheme.org/",application:null,"search-option":null,"post-blank":0,"is-internal":!1,"target-ref":null,"is-inline-image":!1},contents:[]},"\n"]}]},{$$data_type:"org-node",type:"footnote-definition",ref:"orgf20e7f9",properties:{label:"3","pre-blank":0,"post-blank":1,"post-affiliated":29643},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org3fcc84e",properties:{"post-blank":0,"post-affiliated":29650},contents:[{$$data_type:"org-node",type:"link",ref:"org99c5a86",properties:{type:"https",path:"//nixos.org/",format:"plain","raw-link":"https://nixos.org/",application:null,"search-option":null,"post-blank":0,"is-internal":!1,"target-ref":null,"is-inline-image":!1},contents:[]},"\n"]}]},{$$data_type:"org-node",type:"footnote-definition",ref:"orgf0a1602",properties:{label:"2","pre-blank":0,"post-blank":1,"post-affiliated":29670},contents:[{$$data_type:"org-node",type:"paragraph",ref:"orgd66a8dc",properties:{"post-blank":0,"post-affiliated":29677},contents:[{$$data_type:"org-node",type:"link",ref:"org0b970a5",properties:{type:"https",path:"//cons.io/",format:"plain","raw-link":"https://cons.io/",application:null,"search-option":null,"post-blank":0,"is-internal":!1,"target-ref":null,"is-inline-image":!1},contents:[]},"\n"]}]},{$$data_type:"org-node",type:"footnote-definition",ref:"orgd14c2d3",properties:{label:"1","pre-blank":0,"post-blank":0,"post-affiliated":29695},contents:[{$$data_type:"org-node",type:"paragraph",ref:"org5fb54d1",properties:{"post-blank":0,"post-affiliated":29702},contents:["TODO: Find a link to the cvs of mozilla/netscape that has the CL program!\n"]}]}]}]}]};